# 微信推送通知功能配置说明

## 功能概述

根据[微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html)，本功能实现了完整的订阅消息推送系统，支持用户勾选"总是保持以上选择，不再询问"。

当用户晚上9点前没有进行打卡时，系统会自动发送微信推送通知提醒用户打卡。

## 核心特性

### 1. "总是允许"功能
- 用户可以选择"总是保持以上选择，不再询问"
- 选择后，模板消息会被添加到用户的小程序设置页
- 系统可以自动发送消息，无需重复授权

### 2. 订阅状态管理
- **accept（已开启）**：用户同意订阅，将自动接收提醒
- **reject（已关闭）**：用户拒绝订阅，不会接收提醒
- **ban（已禁用）**：已被后台封禁，需要在微信设置中开启

## 配置步骤

### 1. 环境变量配置

```bash
# 微信小程序配置
export WX_APPID="你的微信小程序AppID"
export WX_APP_SECRET="你的微信小程序AppSecret"

# 微信推送模板ID
export WX_TEMPLATE_ID="你的模板消息ID"
```

### 2. 微信公众平台配置

#### 2.1 获取模板消息ID

1. 登录微信公众平台 (https://mp.weixin.qq.com/)
2. 进入"功能" -> "订阅消息"
3. 添加新模板，选择"订阅消息"类型
4. 配置模板内容，建议包含以下字段：
   - 标题 (thing1)
   - 内容 (thing2) 
   - 时间 (time3)
   - 备注 (thing4)

#### 2.2 模板示例

```
标题：{{thing1.DATA}}
内容：{{thing2.DATA}}
时间：{{time3.DATA}}
备注：{{thing4.DATA}}
```

### 3. 小程序端配置

#### 3.1 订阅消息权限请求

根据微信官方文档，`wx.requestSubscribeMessage` API支持以下特性：

- **用户交互要求**：必须在用户主动点击操作时调用
- **总是允许选项**：用户可勾选"总是保持以上选择，不再询问"
- **状态返回**：返回用户对每个模板的订阅状态

#### 3.2 实现方式

1. **首页提醒按钮**：用户点击"开启打卡提醒"按钮
2. **设置页面管理**：用户可以在设置页面管理订阅权限
3. **状态同步**：本地存储 + 微信API状态同步

## 功能实现

### 1. 后端服务

- **定时任务**：每天晚上8:30自动检查用户打卡状态
- **推送服务**：通过微信API发送模板消息
- **状态管理**：记录和管理用户订阅状态

### 2. 前端实现

- **权限请求**：在用户点击时调用 `wx.requestSubscribeMessage`
- **状态检查**：使用 `wx.getSetting` 检查订阅状态
- **用户引导**：提供清晰的设置说明和操作指引

### 3. 消息内容

- **标题**：打卡提醒
- **内容**：今日尚未打卡
- **时间**：当前时间
- **备注**：请及时完成今日打卡，以保持进度

## API接口

### 1. 获取模板ID
```
GET /api/template_id
```

### 2. 手动触发检查
```
POST /api/check_reminders
```

## 使用流程

### 1. 用户首次使用
1. 用户点击"开启打卡提醒"按钮
2. 系统弹出订阅消息授权弹窗
3. 用户选择"总是允许"或"仅本次允许"
4. 系统记录订阅状态

### 2. 自动推送
1. 每天晚上8:30系统自动检查
2. 对未打卡用户发送提醒消息
3. 如果用户选择了"总是允许"，无需重复授权

### 3. 状态管理
1. 用户可在设置页面查看订阅状态
2. 可以重新设置订阅权限
3. 支持进入微信系统设置管理

## 注意事项

1. **用户交互**：订阅消息请求必须在用户主动点击时进行
2. **模板配置**：确保模板ID正确配置且模板内容符合要求
3. **频率限制**：注意微信API的调用频率限制
4. **错误处理**：妥善处理各种订阅状态和错误情况

## 参考文档

- [wx.requestSubscribeMessage API文档](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html)
- [订阅消息语音提醒](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html#%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E8%AF%AD%E9%9F%B3%E6%8F%90%E9%86%92) 